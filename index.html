<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>iStockView ‚Äì Horizontal Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg-color: #f8f9fa;
      --card-color: #fff;
      --text-color: #333;
      --border-color: #ccc;
    }
    [data-theme="dark"] {
      --bg-color: #1e1e2f;
      --card-color: #2c2c3c;
      --text-color: #f1f1f1;
      --border-color: #444;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 10px;
      background: var(--bg-color);
      color: var(--text-color);
      overflow-x: auto;
    }
    h2 {
      text-align: center;
      font-size: 1.4rem;
      margin-bottom: 10px;
    }
    .controls {
      text-align: center;
      margin-bottom: 10px;
    }
    select, button, input {
      font-size: 0.9rem;
      padding: 5px 8px;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid var(--border-color);
    }
    .scroll-container {
      display: flex;
      flex-direction: row;
      gap: 10px;
      overflow-x: auto;
    }
    .card {
      background: var(--card-color);
      min-width: 300px;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }
    .card h3 {
      font-size: 1rem;
      color: #0d6efd;
      margin-bottom: 5px;
      text-align: center;
    }
    canvas {
      max-height: 160px;
    }
    table {
      width: 100%;
      font-size: 0.85rem;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid var(--border-color);
      padding: 4px;
      text-align: center;
    }
    th {
      background-color: #0d6efd;
      color: white;
    }
  </style>
</head>
<body>
  <h2>iStockView ‚Äì Horizontal Dashboard</h2>
  <div class="controls">
    <label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
    <select id="monthSelector"></select>
    <label>DOI > </label><input type="number" id="doiFilter" placeholder="0" style="width:60px;" />
    <button id="refreshBtn">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà</button>
    <button id="clearBtn">‚ùå ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</button>
    <button id="exportCSV">‚¨áÔ∏è CSV</button>
    <button id="exportPDF">üñ®Ô∏è PDF</button>
    <button id="toggleTheme">üåì ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°</button>
  </div>

  <div class="scroll-container" id="dashboard">
    <div class="card"><h3>üìã DOI Table</h3><table id="tableDOI"><thead><tr><th>Item</th><th>DOI</th><th>Category</th><th>Turnover</th><th>Action</th></tr></thead><tbody></tbody></table></div>
    <div class="card">
      <h3>üìà ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô (DOI > 180)</h3>
      <canvas id="chartCritical"></canvas>
    </div>
  </div>

  <script>
    let rawData = [];
    let currentTheme = 'light';
    let criticalChart;

    async function loadData() {
      const res = await fetch('https://raw.githubusercontent.com/Benja1476/dashboard/5c26e64ebee875a295380b00559c4e194737f849/data.json');
      rawData = await res.json();
      const months = [...new Set(rawData.map(d => d.date))].sort();
      const selector = document.getElementById('monthSelector');
      selector.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
      selector.value = months[0];
      updateDashboard();
    }

    function updateDashboard() {
      const month = document.getElementById('monthSelector').value;
      const doiMin = parseFloat(document.getElementById('doiFilter').value) || 0;
      const data = rawData.filter(d => d.date === month && (d.doi ?? 0) > doiMin);

      const tbody = document.querySelector('#tableDOI tbody');
      tbody.innerHTML = data.map(d => `
        <tr>
          <td>${d.item}</td>
          <td>${d.doi ?? '-'}</td>
          <td>${d.category || '-'}</td>
          <td>${d.turnover || '-'}</td>
          <td>${d.action || '-'}</td>
        </tr>`).join('');

      const criticalItems = data.filter(d => (d.doi || 0) > 180).sort((a,b) => b.doi - a.doi).slice(0, 10);
      const ctx = document.getElementById('chartCritical').getContext('2d');
      if (criticalChart) criticalChart.destroy();
      criticalChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: criticalItems.map(d => d.item),
          datasets: [{
            label: 'DOI > 180',
            data: criticalItems.map(d => d.doi),
            backgroundColor: '#dc3545'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    document.getElementById("refreshBtn").onclick = updateDashboard;
    document.getElementById("clearBtn").onclick = () => {
      document.getElementById("doiFilter").value = "";
      updateDashboard();
    };

    document.getElementById("exportCSV").onclick = () => {
      const rows = [...document.querySelectorAll('#tableDOI tr')].map(tr =>
        [...tr.children].map(td => '"' + td.innerText + '"').join(',')).join('\n');
      const blob = new Blob([rows], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'DOI_table.csv';
      a.click();
    };

    document.getElementById("exportPDF").onclick = () => {
      import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js').then(({ jsPDF }) => {
        const doc = new jsPDF();
        doc.text("DOI Trend Table", 10, 10);
        let y = 20;
        document.querySelectorAll('#tableDOI tbody tr').forEach(tr => {
          const text = [...tr.children].map(td => td.innerText).join(' | ');
          doc.text(text, 10, y);
          y += 10;
        });
        doc.save('DOI_table.pdf');
      });
    };

    document.getElementById("toggleTheme").onclick = () => {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', currentTheme);
    };

    loadData();
  </script>
</body>
</html>
