<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iStockView ‚Äì Strategic Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --bg-color: #f4f6f9;
      --card-bg: #ffffff;
      --text-color: #333;
    }
    body.dark {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #f0f0f0;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 10px;
    }
    h2 {
      text-align: center;
      font-size: 1.6rem;
      margin-bottom: 10px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    button, select, input {
      font-size: 0.9rem;
      padding: 6px 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 10px;
    }
    .card {
      background: var(--card-bg);
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .card h3 {
      font-size: 1rem;
      margin-bottom: 5px;
      color: #0d6efd;
      text-align: center;
    }
    canvas { max-height: 180px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th, td { border: 1px solid #dee2e6; padding: 4px; text-align: center; }
    th { background-color: #0d6efd; color: white; }
    #tableDOITrend th { background-color: #20c997; }
    .hidden { display: none !important; }
    @media (max-width: 768px) {
      h2 { font-size: 1.2rem; }
      .card canvas { max-height: 150px; }
    }
  </style>
</head>
<body>
  <h2>üìä iStockView ‚Äì Strategic Dashboard</h2>
  <div class="controls">
    <label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: <select id="monthSelector"></select></label>
    <label>‡∏´‡∏°‡∏ß‡∏î:
      <select id="filterSelect">
        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="A">Category A</option>
        <option value="B">Category B</option>
        <option value="C">Category C</option>
        <option value="Fast">FSN Fast</option>
        <option value="Slow">FSN Slow</option>
        <option value="Non-Moving">FSN Non-Moving</option>
      </select>
    </label>
    <label>DOI > <input type="number" id="doiMin" value="0" style="width:70px"></label>
    <label>Aging < <input type="number" id="agingMax" value="999" style="width:70px"></label>
    <button id="refreshBtn">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà</button>
    <button id="clearBtn">üßπ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</button>
    <button id="toggleGraphsBtn">üìâ ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü</button>
    <button id="toggleThemeBtn">üåô ‡∏ò‡∏µ‡∏°</button>
    <button id="exportCsvBtn">üíæ Export CSV</button>
    <button id="exportPdfBtn">üìÑ Export PDF</button>
  </div>

  <div class="grid" id="dashboardGrid">
    <div class="card">
      <h3>ABC Category</h3>
      <canvas id="chartABC"></canvas>
    </div>
    <div class="card">
      <h3>DOI Trend</h3>
      <canvas id="chartDOI"></canvas>
    </div>
    <div class="card">
      <h3>Turnover Rate</h3>
      <canvas id="chartTurnover"></canvas>
    </div>
    <div class="card">
      <h3>FSN Category</h3>
      <canvas id="chartFSN"></canvas>
    </div>
    <div class="card" style="grid-column: span 2">
      <h3>Aging Inventory</h3>
      <canvas id="chartAging"></canvas>
    </div>
    <div class="card" style="grid-column: span 2">
      <h3>Inventory Insights</h3>
      <canvas id="chartInsights"></canvas>
    </div>
    <div class="card">
      <h3>Action Plan Summary</h3>
      <table id="tableActions">
        <thead><tr><th>Action</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card">
      <h3>Top 10 Inventory</h3>
      <table id="topTable">
        <thead><tr><th>Item</th><th>Qty</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let rawData = [];
    let charts = {};
    let months = [];

    function drawOrUpdateChart(id, type, data) {
      if (charts[id]) {
        charts[id].data = data;
        charts[id].update();
      } else {
        charts[id] = new Chart(document.getElementById(id), {
          type,
          data,
          options: {
            responsive: true,
            plugins: {
              legend: { display: true, position: 'bottom' },
              tooltip: { enabled: true }
            }
          }
        });
      }
    }

    async function loadData() {
      try {
        const res = await fetch('https://raw.githubusercontent.com/Benja1476/dashboard/5c26e64ebee875a295380b00559c4e194737f849/data.json');
        rawData = await res.json();

        const selector = document.getElementById('monthSelector');
        selector.innerHTML = "";
        months = [...new Set(rawData.map(d => d.date))].sort();
        months.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m;
          opt.textContent = m;
          selector.appendChild(opt);
        });

        if (!selector.value && months.length > 0) {
          selector.value = months[0];
        }

        updateDashboard();

      } catch (error) {
        alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + error);
      }
    }

    function updateDashboard() {
      const month = document.getElementById('monthSelector').value;
      const filter = document.getElementById('filterSelect').value;
      const doiMin = Number(document.getElementById('doiMin').value);
      const agingMax = Number(document.getElementById('agingMax').value);

      let data = rawData.filter(d => d.date === month);

      // Filter by category
      if (filter !== 'all') {
        if (['A','B','C'].includes(filter)) {
          data = data.filter(d => d.category === filter);
        } else if (['Fast','Slow','Non-Moving'].includes(filter)) {
          const fsnMap = { 'Fast': 'F', 'Slow': 'S', 'Non-Moving': 'N' };
          data = data.filter(d => d.fsn === fsnMap[filter]);
        }
      }

      // Filter by DOI and Aging
      data = data.filter(d => (d.doi >= doiMin) && (d.aging <= agingMax));

      // Top 10 Inventory Table
      const topTableBody = document.querySelector('#topTable tbody');
      topTableBody.innerHTML = data
        .sort((a,b) => b.qty - a.qty)
        .slice(0, 10)
        .map(r => `<tr><td>${r.item}</td><td>${r.qty}</td></tr>`).join('');

      // Action Plan Summary Table
      const actionCounts = {};
      data.forEach(d => {
        const act = d.action || 'No Action';
        actionCounts[act] = (actionCounts[act] || 0) + 1;
      });
      const actionTbody = document.querySelector('#tableActions tbody');
      actionTbody.innerHTML = Object.entries(actionCounts)
        .map(([act, count]) => `<tr><td>${act}</td><td>${count}</td></tr>`).join('');

      // ABC Category Chart
      const abcCount = {A:0, B:0, C:0};
      data.forEach(d => {
        if (d.category) abcCount[d.category] = (abcCount[d.category] || 0) + 1;
      });
      drawOrUpdateChart('chartABC', 'doughnut', {
        labels: ['A', 'B', 'C'],
        datasets: [{
          data: [abcCount.A, abcCount.B, abcCount.C],
          backgroundColor: ['#28a745', '#ffc107', '#dc3545']
        }]
      });

      // DOI Trend Chart
      const doiValues = data.map(d => d.doi || 0);
      const doiLabels = data.map(d => d.item);
      drawOrUpdateChart('chartDOI', 'line', {
        labels: doiLabels,
        datasets: [{
          label: 'Days of Inventory (DOI)',
          data: doiValues,
          fill: false,
          borderColor: '#17a2b8',
          tension: 0.3
        }]
      });

      // Turnover Rate Chart
      const turnoverGroup = {};
      data.forEach(d => {
        const key = d.turnover || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        turnoverGroup[key] = (turnoverGroup[key] || 0) + 1;
      });
      const turnoverLabelMap = {
        'Monthly': '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
        'Quarterly': '‡∏£‡∏≤‡∏¢‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™',
        'Yearly': '‡∏£‡∏≤‡∏¢‡∏õ‡∏µ',
        'Weekly': '‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
        '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏': '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
      };
      const turnoverLabels = Object.keys(turnoverGroup).map(k => turnoverLabelMap[k] || k);
      drawOrUpdateChart('chartTurnover', 'doughnut', {
        labels: turnoverLabels,
        datasets: [{
          data: Object.values(turnoverGroup),
          backgroundColor: ['#007bff', '#ffc107', '#28a745', '#dc3545', '#6c757d']
        }]
      });

      // FSN Category Chart
      const fsnMap = { F: "Fast", S: "Slow", N: "Non-Moving" };
      const fsnCount = { Fast: 0, Slow: 0, "Non-Moving": 0 };
      data.forEach(d => {
        const label = fsnMap[d.fsn] || null;
        if (label) fsnCount[label]++;
      });
      drawOrUpdateChart('chartFSN', 'pie', {
        labels: Object.keys(fsnCount),
        datasets: [{
          data: Object.values(fsnCount),
          backgroundColor: ['#20c997', '#fd7e14', '#6c757d']
        }]
      });

      // Aging Inventory Chart
      const agingRanges = ['0-90 ‡∏ß‡∏±‡∏ô', '91-180 ‡∏ß‡∏±‡∏ô', '181-360 ‡∏ß‡∏±‡∏ô', '360+ ‡∏ß‡∏±‡∏ô'];
      const agingCounts = [0, 0, 0, 0];
      data.forEach(d => {
        if (d.aging <= 90) agingCounts[0]++;
        else if (d.aging <= 180) agingCounts[1]++;
        else if (d.aging <= 360) agingCounts[2]++;
        else agingCounts[3]++;
      });
      drawOrUpdateChart('chartAging', 'bar', {
        labels: agingRanges,
        datasets: [{
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
          data: agingCounts,
          backgroundColor: '#6f42c1'
        }]
      });

      // Inventory Insights Chart
      const insights = { 'Fast': 0, 'Slow': 0, 'Non-Moving': 0 };
      data.forEach(d => {
        const key = fsnMap[d.fsn] || null;
        if (key && insights[key] !== undefined) insights[key]++;
      });
      drawOrUpdateChart('chartInsights', 'polarArea', {
        labels: Object.keys(insights),
        datasets: [{
          data: Object.values(insights),
          backgroundColor: ['#198754', '#ffc107', '#dc3545']
        }]
      });
    }

    // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå
    function resetFilters() {
      document.getElementById('filterSelect').value = 'all';
      document.getElementById('doiMin').value = 0;
      document.getElementById('agingMax').value = 999;
      updateDashboard();
    }

    // ‡∏õ‡∏∏‡πà‡∏°‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü
    function toggleGraphs() {
      const grid = document.getElementById('dashboardGrid');
      grid.classList.toggle('hidden');
    }

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°
    function toggleTheme() {
      document.body.classList.toggle('dark');
    }

    // Export CSV
    function exportCSV() {
      const month = document.getElementById('monthSelector').value;
      const filter = document.getElementById('filterSelect').value;
      const doiMin = Number(document.getElementById('doiMin').value);
      const agingMax = Number(document.getElementById('agingMax').value);
      let data = rawData.filter(d => d.date === month);

      if (filter !== 'all') {
        if (['A','B','C'].includes(filter)) {
          data = data.filter(d => d.category === filter);
        } else if (['Fast','Slow','Non-Moving'].includes(filter)) {
          const fsnMap = { 'Fast': 'F', 'Slow': 'S', 'Non-Moving': 'N' };
          data = data.filter(d => d.fsn === fsnMap[filter]);
        }
      }
      data = data.filter(d => (d.doi >= doiMin) && (d.aging <= agingMax));

      let csv = 'Item,Qty,Category,DOI,Aging,Turnover,FSN,Action\\n';
      data.forEach(d => {
        csv += `"${d.item}",${d.qty},"${d.category}",${d.doi},${d.aging},"${d.turnover}","${d.fsn}","${d.action || ''}"\\n`;
      });
      const blob = new Blob([csv], {type: 'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `iStockView_${month}.csv`;
      a.click();
    }

    // Export PDF (‡πÉ‡∏ä‡πâ jsPDF + AutoTable)
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const month = document.getElementById('monthSelector').value;

      const filter = document.getElementById('filterSelect').value;
      const doiMin = Number(document.getElementById('doiMin').value);
      const agingMax = Number(document.getElementById('agingMax').value);
      let data = rawData.filter(d => d.date === month);

      if (filter !== 'all') {
        if (['A','B','C'].includes(filter)) {
          data = data.filter(d => d.category === filter);
        } else if (['Fast','Slow','Non-Moving'].includes(filter)) {
          const fsnMap = { 'Fast': 'F', 'Slow': 'S', 'Non-Moving': 'N' };
          data = data.filter(d => d.fsn === fsnMap[filter]);
        }
      }
      data = data.filter(d => (d.doi >= doiMin) && (d.aging <= agingMax));

      const rows = data.map(d => [
        d.item, d.qty, d.category, d.doi, d.aging, d.turnover, d.fsn, d.action || ''
      ]);
      doc.text(`iStockView ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${month}`, 10, 10);
      doc.autoTable({
        head: [['Item', 'Qty', 'Category', 'DOI', 'Aging', 'Turnover', 'FSN', 'Action']],
        body: rows,
        startY: 20,
        styles: { fontSize: 7 }
      });
      doc.save(`iStockView_${month}.pdf`);
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô localStorage
    function saveSettings() {
      const settings = {
        month: document.getElementById('monthSelector').value,
        filter: document.getElementById('filterSelect').value,
        doiMin: document.getElementById('doiMin').value,
        agingMax: document.getElementById('agingMax').value,
        darkMode: document.body.classList.contains('dark'),
        graphsHidden: document.getElementById('dashboardGrid').classList.contains('hidden'),
      };
      localStorage.setItem('iStockViewSettings', JSON.stringify(settings));
    }
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å localStorage
    function loadSettings() {
      const settings = JSON.parse(localStorage.getItem('iStockViewSettings'));
      if (settings) {
        if (months.includes(settings.month)) {
          document.getElementById('monthSelector').value = settings.month;
        }
        document.getElementById('filterSelect').value = settings.filter || 'all';
        document.getElementById('doiMin').value = settings.doiMin || 0;
        document.getElementById('agingMax').value = settings.agingMax || 999;
        if (settings.darkMode) document.body.classList.add('dark');
        else document.body.classList.remove('dark');
        if (settings.graphsHidden) document.getElementById('dashboardGrid').classList.add('hidden');
        else document.getElementById('dashboardGrid').classList.remove('hidden');
      }
    }

    document.getElementById('monthSelector').addEventListener('change', () => { updateDashboard(); saveSettings(); });
    document.getElementById('filterSelect').addEventListener('change', () => { updateDashboard(); saveSettings(); });
    document.getElementById('doiMin').addEventListener('input', () => { updateDashboard(); saveSettings(); });
    document.getElementById('agingMax').addEventListener('input', () => { updateDashboard(); saveSettings(); });

    document.getElementById('refreshBtn').addEventListener('click', () => loadData());
    document.getElementById('clearBtn').addEventListener('click', () => { resetFilters(); saveSettings(); });
    document.getElementById('toggleGraphsBtn').addEventListener('click', () => { toggleGraphs(); saveSettings(); });
    document.getElementById('toggleThemeBtn').addEventListener('click', () => { toggleTheme(); saveSettings(); });

    document.getElementById('exportCsvBtn').addEventListener('click', () => exportCSV());
    document.getElementById('exportPdfBtn').addEventListener('click', () => exportPDF());

    window.addEventListener('beforeunload', saveSettings);

    async function init() {
      await loadData();
      loadSettings();
      updateDashboard();
    }
    init();
  </script>
</body>
</html>
